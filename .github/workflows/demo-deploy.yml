name: Demo GCP Deploy

on:
  push:
    branches:
      - master
    paths:
      - "demo/**"
      - "ui/**"
      - ".github/workflows/demo-deploy.yml"
  pull_request:
    paths:
      - "demo/**"
      - "ui/**"
      - ".github/workflows/demo-deploy.yml"

env:
  GCP_PROJECT_ID: flourish-terreno
  BUCKET: flourish-terreno-terreno-demo
  BACKEND_BUCKET: terreno-demo-backend

jobs:
  build:
    name: Build Demo
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install root dependencies (workspace)
        run: bun install --frozen-lockfile

      - name: Build UI dependency
        run: bun run compile
        working-directory: ui

      - name: Export demo for web
        run: bun run export
        working-directory: demo

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: demo-dist
          path: demo/dist
          retention-days: 1

  deploy-production:
    name: Deploy to Production
    needs: build
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: demo-dist
          path: dist

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Deploy to GCS
        run: |
          # Sync all files with long cache, excluding previews dir and index.html
          gsutil -m -h "Cache-Control:public, max-age=31536000, immutable" \
            rsync -r -d -x '_previews/.*|index\.html$' \
            dist/ "gs://$BUCKET/"

          # Upload index.html with no-cache
          gsutil -h "Cache-Control:no-cache, no-store, must-revalidate" \
            cp dist/index.html "gs://$BUCKET/index.html"

          # Upload route files at bare paths (e.g. /demo) so GCS serves them
          # directly instead of redirecting /demo -> /demo/index.html
          find dist -mindepth 2 -name 'index.html' | while read -r f; do
            route="${f#dist/}"
            route="${route%/index.html}"
            gsutil -h "Cache-Control:no-cache, no-store, must-revalidate" \
              cp "$f" "gs://$BUCKET/$route"
            echo "Uploaded route file: $route"
          done

      - name: Invalidate CDN cache
        run: |
          gcloud compute url-maps invalidate-cdn-cache terreno-demo-url-map \
            --path "/*" --async

      - name: Output deploy info
        run: echo "Demo deployed to gs://$BUCKET"

  deploy-preview:
    name: Deploy Preview
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    steps:
      - uses: actions/checkout@v6

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Get CDN IP
        id: cdn
        run: |
          IP=$(gcloud compute addresses describe terreno-demo-ip --global --format="value(address)" 2>/dev/null || echo "")
          if [ -n "$IP" ]; then
            echo "ip=$IP" >> "$GITHUB_OUTPUT"
            echo "base_url=/_previews/pr-${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
            echo "preview_url=http://$IP/_previews/pr-${{ github.event.pull_request.number }}/" >> "$GITHUB_OUTPUT"
            echo "CDN IP: $IP"
          else
            echo "ip=" >> "$GITHUB_OUTPUT"
            echo "base_url=/${{ env.BUCKET }}/_previews/pr-${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
            echo "preview_url=https://storage.googleapis.com/${{ env.BUCKET }}/_previews/pr-${{ github.event.pull_request.number }}/index.html" >> "$GITHUB_OUTPUT"
            echo "CDN not configured, falling back to storage.googleapis.com"
          fi

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install root dependencies (workspace)
        run: bun install --frozen-lockfile

      - name: Build UI dependency
        run: bun run compile
        working-directory: ui

      - name: Set baseUrl for preview
        run: |
          cd demo
          node -e "
            const fs = require('fs');
            const config = JSON.parse(fs.readFileSync('app.json', 'utf8'));
            config.expo.web = config.expo.web || {};
            config.expo.web.output = 'static';
            config.expo.experiments = config.expo.experiments || {};
            config.expo.experiments.baseUrl = '${{ steps.cdn.outputs.base_url }}';
            fs.writeFileSync('app.json', JSON.stringify(config, null, 2));
          "

      - name: Export demo for web
        run: bun run export
        working-directory: demo

      - name: Deploy preview to GCS
        run: |
          PREVIEW_PATH="_previews/pr-${{ github.event.pull_request.number }}"
          gsutil -m -h "Cache-Control:no-cache" \
            rsync -r -d \
            demo/dist/ "gs://$BUCKET/$PREVIEW_PATH/"

          # Upload route files at bare paths
          find demo/dist -mindepth 2 -name 'index.html' | while read -r f; do
            route="${f#demo/dist/}"
            route="${route%/index.html}"
            gsutil -h "Cache-Control:no-cache" \
              cp "$f" "gs://$BUCKET/$PREVIEW_PATH/$route"
            echo "Uploaded route file: $PREVIEW_PATH/$route"
          done

      - name: Create deployment
        uses: actions/github-script@v7
        with:
          script: |
            const pr = ${{ github.event.pull_request.number }};
            const url = '${{ steps.cdn.outputs.preview_url }}';
            const deployment = await github.rest.repos.createDeployment({
              ...context.repo,
              ref: context.sha,
              environment: `demo-preview-pr-${pr}`,
              auto_merge: false,
              required_contexts: [],
              transient_environment: true,
            });
            await github.rest.repos.createDeploymentStatus({
              ...context.repo,
              deployment_id: deployment.data.id,
              state: 'success',
              environment_url: url,
              log_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
            });
            core.info(`Preview deployed to ${url}`);
