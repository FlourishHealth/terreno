name: Preview Cleanup

on:
  pull_request:
    types: [closed]

env:
  GCP_PROJECT_ID: flourish-terreno

jobs:
  cleanup:
    name: Delete Preview Files
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Delete demo preview
        continue-on-error: true
        run: |
          gsutil -m rm -r "gs://flourish-terreno-terreno-demo/_previews/pr-${{ github.event.pull_request.number }}/" || true

      - name: Delete frontend-example preview
        continue-on-error: true
        run: |
          gsutil -m rm -r "gs://flourish-terreno-terreno-frontend-example/_previews/pr-${{ github.event.pull_request.number }}/" || true

      - name: Deactivate deployments
        uses: actions/github-script@v7
        with:
          script: |
            const pr = ${{ github.event.pull_request.number }};
            const envNames = [
              `demo-preview-pr-${pr}`,
              `frontend-example-preview-pr-${pr}`,
            ];
            for (const envName of envNames) {
              try {
                const deployments = await github.rest.repos.listDeployments({
                  ...context.repo,
                  environment: envName,
                });
                for (const deployment of deployments.data) {
                  await github.rest.repos.createDeploymentStatus({
                    ...context.repo,
                    deployment_id: deployment.id,
                    state: 'inactive',
                  });
                }
              } catch (e) {
                core.info(`No deployments found for ${envName}`);
              }
            }
