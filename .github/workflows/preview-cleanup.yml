name: Preview Cleanup

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    name: Deactivate Preview Deployments
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Deactivate deployments
        uses: actions/github-script@v7
        with:
          script: |
            const pr = ${{ github.event.pull_request.number }};
            const envNames = [
              `demo-preview-pr-${pr}`,
              `example-frontend-preview-pr-${pr}`,
            ];
            for (const envName of envNames) {
              try {
                const deployments = await github.rest.repos.listDeployments({
                  ...context.repo,
                  environment: envName,
                });
                for (const deployment of deployments.data) {
                  await github.rest.repos.createDeploymentStatus({
                    ...context.repo,
                    deployment_id: deployment.id,
                    state: 'inactive',
                  });
                }
              } catch (e) {
                core.info(`No deployments found for ${envName}`);
              }
            }
