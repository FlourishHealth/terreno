---
description: When creating an API to expose a model
alwaysApply: false
---

# Exposing Mongoose Models with ModelRouter

ModelRouter provides a powerful way to automatically create RESTful CRUD APIs for Mongoose models. It generates standard endpoints (GET, POST, PUT/PATCH, DELETE) with built-in support for permissions, population, filtering, and lifecycle hooks.

## Basic Structure

Create a new file in `backend/src/api/` with this pattern:

```typescript
import {modelRouter, ModelRouterOptions, Permissions} from "@terreno/api";
import {YourModel} from "../models";
import {YourModelDocument, UserDocument} from "../types";

export const addYourModelRoutes = (
  router: any,
  options?: Partial<ModelRouterOptions<YourModelDocument>>
): void => {
  router.use(
    "/yourModels",
    modelRouter(YourModel, {
      ...options,
      permissions: {
        list: [Permissions.IsAuthenticated],
        create: [Permissions.IsAuthenticated],
        read: [Permissions.IsOwner],
        update: [Permissions.IsOwner],
        delete: [Permissions.IsOwner],
      },
      sort: "-created",
    })
  );
};
```

## Generated Endpoints

ModelRouter automatically creates these endpoints:

- `GET /yourModels` - List resources (with pagination, filtering, sorting)
- `POST /yourModels` - Create a new resource
- `GET /yourModels/:id` - Read a single resource
- `PATCH /yourModels/:id` - Update a resource
- `DELETE /yourModels/:id` - Delete a resource (soft delete if model has `deleted` field)

## Permissions

The `permissions` object defines who can access each CRUD operation using permission functions.

### Built-in Permission Functions

Available from `@terreno/api`:
- `Permissions.IsAny` - Anyone (including anonymous)
- `Permissions.IsAuthenticated` - Any authenticated user
- `Permissions.IsOwner` - User owns the resource (via `ownerId` field)

### Permission Configuration

```typescript
permissions: {
  list: [Permissions.IsAuthenticated],
  create: [Permissions.IsAuthenticated],
  read: [Permissions.IsOwner],
  update: [Permissions.IsOwner],
  delete: [],  // Empty array disables the operation
}
```

## Lifecycle Hooks

### preCreate

Runs before creating a document. Must return the document.

```typescript
preCreate: (body, req) => {
  return {
    ...body,
    ownerId: (req.user as UserDocument)?._id,
  } as YourModelDocument;
}
```

### postCreate

Runs after creating a document.

```typescript
postCreate: async (document, req): Promise<void> => {
  await sendNotification(document);
}
```

### preUpdate

Runs before updating. Must return the update data.

```typescript
preUpdate: async (updateData, req) => {
  // Validate or modify update data
  return updateData;
}
```

### postUpdate

Runs after updating. Has access to previous value.

```typescript
postUpdate: async (updatedDoc, cleanedBody, req, prevValue): Promise<void> => {
  // Sync changes or log
}
```

### preDelete / postDelete

Run before/after deletion.

## Additional Options

### queryFields

Allow filtering on specific fields:

```typescript
queryFields: ["completed", "ownerId", "type"]
```

### queryFilter

Apply filtering based on user. Use `OwnerQueryFilter` for common owner-based filtering:

```typescript
import {OwnerQueryFilter} from "@terreno/api";

queryFilter: OwnerQueryFilter
```

### sort

Default sorting:

```typescript
sort: "-created"  // Descending by created date
sort: "name"      // Ascending by name
```

### populatePaths

Populate referenced documents:

```typescript
populatePaths: [
  {path: "userId", fields: ["name", "email"]}
]
```

## Complete Example

```typescript
import {modelRouter, ModelRouterOptions, OwnerQueryFilter, Permissions} from "@terreno/api";
import {Todo} from "../models";
import {TodoDocument, UserDocument} from "../types";

export const addTodoRoutes = (
  router: any,
  options?: Partial<ModelRouterOptions<TodoDocument>>
): void => {
  router.use(
    "/todos",
    modelRouter(Todo, {
      ...options,
      permissions: {
        create: [Permissions.IsAuthenticated],
        delete: [Permissions.IsOwner],
        list: [Permissions.IsAuthenticated],
        read: [Permissions.IsOwner],
        update: [Permissions.IsOwner],
      },
      preCreate: (body, req) => {
        return {
          ...body,
          ownerId: (req.user as UserDocument)?._id,
        } as TodoDocument;
      },
      queryFields: ["completed", "ownerId"],
      queryFilter: OwnerQueryFilter,
      sort: "-created",
    })
  );
};
```

## Export and Register Routes

1. Export from `backend/src/api/index.ts`:
```typescript
export * from "./yourModel";
```

2. Register in server setup:
```typescript
import {addYourModelRoutes} from "./api";
addYourModelRoutes(router, options);
```

## Generate SDK

After modifying routes, regenerate the SDK:
```bash
bun run sdk
```
