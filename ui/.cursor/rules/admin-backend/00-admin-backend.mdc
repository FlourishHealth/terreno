---
description: @terreno/admin-backend - Admin panel backend plugin for @terreno/api
globs: **/*
---

# @terreno/admin-backend

Admin panel backend plugin for @terreno/api that auto-generates admin CRUD endpoints for Mongoose models. This is a **backend-only** package — no React, no UI components, no frontend code.

## Commands

```bash
bun run compile          # Compile TypeScript
bun run dev              # Watch mode (TypeScript watch)
bun run lint             # Lint code
bun run lint:fix         # Fix lint issues
bun run test             # Run tests (currently placeholder)
```

## Architecture

### File Structure

```
src/
  adminApp.ts            # AdminApp class - registers admin routes
  index.ts               # Package exports
```

### Key Concepts

The admin backend provides:
- **AdminApp class**: Registers admin routes for configured models
- **Auto-generated CRUD routes**: Uses @terreno/api's modelRouter with IsAdmin permissions
- **Metadata endpoint**: `/admin/config` returns model schemas and field metadata for frontend
- **OpenAPI integration**: Extracts field metadata from Mongoose schemas via getOpenApiSpecForModel

## Usage

```typescript
import {AdminApp} from "@terreno/admin-backend";
import {User, Todo} from "./models";

const admin = new AdminApp({
  basePath: "/admin",  // Optional, defaults to "/admin"
  models: [
    {
      model: User,
      routePath: "/users",
      displayName: "Users",
      listFields: ["email", "name", "admin"],
      defaultSort: "-created",
    },
    {
      model: Todo,
      routePath: "/todos",
      displayName: "Todos",
      listFields: ["title", "completed", "ownerId"],
    },
  ],
});

// Register with Express app
admin.register(app);
```

### What It Creates

1. **Config endpoint**: `GET /admin/config` — Returns metadata for all registered models (field types, required, refs, descriptions)
2. **CRUD routes**: For each model at `{basePath}{routePath}`:
   - `GET /admin/users` — List users (paginated, sortable)
   - `POST /admin/users` — Create user
   - `GET /admin/users/:id` — Read user
   - `PATCH /admin/users/:id` — Update user
   - `DELETE /admin/users/:id` — Delete user

All routes require `Permissions.IsAdmin`.

## AdminApp Options

```typescript
interface AdminOptions {
  models: AdminModelConfig[];  // Array of model configurations
  basePath?: string;           // Base path for all admin routes (default: "/admin")
}

interface AdminModelConfig {
  model: Model<any>;           // Mongoose model
  routePath: string;           // Route path relative to basePath (e.g., "/users")
  displayName: string;         // Human-readable name for frontend
  listFields: string[];        // Fields to show in list view
  defaultSort?: string;        // Default sort order (default: "-created")
}
```

## Field Metadata Extraction

The `/admin/config` endpoint returns rich metadata for each model field:

```typescript
interface AdminFieldMeta {
  type: string;                // "string" | "number" | "boolean" | "date" | "objectid" | etc.
  required: boolean;           // Whether field is required
  description?: string;        // Field description from schema
  enum?: string[];             // Enum values if applicable
  default?: any;               // Default value
  ref?: string;                // Referenced model name for ObjectId refs
}
```

Metadata is extracted from:
- OpenAPI spec generated by @terreno/api's `getOpenApiSpecForModel`
- Mongoose schema paths (for ref information)

## Permissions

All admin routes use `Permissions.IsAdmin`, which checks `user.admin === true`. Users must be authenticated and have admin privileges.

## Integration with @terreno/admin-frontend

The frontend package uses the `/admin/config` endpoint to:
- Discover available models
- Generate forms with proper field types
- Render references as links
- Validate required fields

## Conventions

- Use `AdminApp` to register admin routes in your Express app setup
- Only expose models that should be editable via admin panel (avoid sensitive internal models)
- Ensure model schemas have `description` on all fields (flows through to admin UI)
- Use `IsAdmin` permission — never expose admin routes to non-admin users
- Use `logger.info/warn/error/debug` for permanent logs
- Testing: bun test with expect, supertest for HTTP requests
